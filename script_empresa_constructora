CREATE DATABASE IF NOT EXISTS DB_EMPRESA_CONSTRUCTORA;

USE DB_EMPRESA_CONSTRUCTORA;

CREATE TABLE PROYECTO (
    ID_PROYECTO INT(11) NOT NULL AUTO_INCREMENT,
    NOMBRE VARCHAR(45) DEFAULT NULL,
    UBICACION VARCHAR(45) DEFAULT NULL,
    DESCRIPCION VARCHAR(45) DEFAULT NULL,
    FECHA_INICIO DATE NOT NULL,
    FECHA_FINALIZACION DATE DEFAULT NULL,
    PRIMARY KEY (ID_PROYECTO));
    
    CREATE TABLE PERSONAL_OBRA (
        ID_PERSONAL INT(11) NOT NULL AUTO_INCREMENT,
        ID_PROYECTO INT(11) NOT NULL,
        NOMBRE VARCHAR(45) NOT NULL,
        APELLIDO VARCHAR(45) NOT NULL,
        TIPO VARCHAR(45) DEFAULT NULL,
        DIRECCION VARCHAR(45) DEFAULT NULL,
        FECHA_ALTA DATE NOT NULL,
        FECHA_BAJA DATE DEFAULT NULL,
        PRIMARY KEY (ID_PERSONAL),
        FOREIGN KEY (ID_PROYECTO) REFERENCES PROYECTO(ID_PROYECTO));
        
         CREATE TABLE TAREAS (
        ID_TAREA INT(11) NOT NULL AUTO_INCREMENT,
        ID_PROYECTO INT(11) DEFAULT NULL,
        ID_PERSONAL INT(11) DEFAULT NULL,
        NOMBRE VARCHAR(45),
        DESCRIPCION VARCHAR(45) DEFAULT NULL,
        FECHA_INICIO DATE DEFAULT NULL,
        FECHA_FINALIZACION DATE DEFAULT NULL,
        PRIMARY KEY (ID_TAREA),
        FOREIGN KEY (ID_PROYECTO) REFERENCES PROYECTO (ID_PROYECTO),
        FOREIGN KEY (ID_PERSONAL) REFERENCES PERSONAL_OBRA (ID_PERSONAL));
        
        CREATE TABLE MATERIALES (
        ID_MATERIAL INT(11) NOT NULL AUTO_INCREMENT,
        NOMBRE VARCHAR(45) DEFAULT NULL,
        DESCRIPCION VARCHAR(45) DEFAULT NULL,
        CANTIDAD DECIMAL(10,2) DEFAULT NULL,
        UNIDAD_MEDIDA VARCHAR(45) DEFAULT NULL,
        PRIMARY KEY (ID_MATERIAL));
      
         CREATE TABLE MATERIALES_PROYECTOS (
        ID_MAT_PROY INT(11) NOT NULL AUTO_INCREMENT,
        ID_PROYECTO INT(11) NOT NULL,
        ID_TAREA INT(11) DEFAULT NULL,
        ID_MATERIAL INT(11) NOT NULL,
        NOMBRE_MATERIAL VARCHAR(45) NOT NULL,
        CANTIDAD DECIMAL(10,2) DEFAULT NULL,
        UNIDAD_MEDIDA VARCHAR(45) DEFAULT NULL,
        PRIMARY KEY (ID_MAT_PROY),
        FOREIGN KEY (ID_PROYECTO) REFERENCES PROYECTO (ID_PROYECTO),
        FOREIGN KEY (ID_TAREA) REFERENCES TAREAS (ID_TAREA),
        FOREIGN KEY (ID_MATERIAL) REFERENCES MATERIALES (ID_MATERIAL));
       
        
           CREATE TABLE MAQUINARIA (
        ID_MAQUINARIA INT(11) NOT NULL AUTO_INCREMENT,
        ID_PROYECTO INT(11) DEFAULT NULL,
        ID_PERSONAL INT(11) DEFAULT NULL,
        NOMBRE VARCHAR(45) NOT NULL,
        DESCRIPCION VARCHAR(200) DEFAULT NULL,
        PRIMARY KEY (ID_MAQUINARIA),
        FOREIGN KEY (ID_PROYECTO) REFERENCES PROYECTO (ID_PROYECTO),
        FOREIGN KEY (ID_PERSONAL) REFERENCES PERSONAL_OBRA (ID_PERSONAL));

CREATE TABLE Clientes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    razon_social VARCHAR(150) NOT NULL,
    id_proyecto INT,
    FOREIGN KEY (id_proyecto) REFERENCES proyecto (id_proyecto)
);

CREATE TABLE proveedores (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    razon_social VARCHAR(150) NOT NULL,
    valoracion INT NOT NULL CHECK (valoracion BETWEEN 1 AND 5)
);

CREATE TABLE facturacion (
    id_factura INT AUTO_INCREMENT PRIMARY KEY,
    fecha_factura DATE NOT NULL,
    id_cliente INT,
    id_proyecto INT,
    total_factura DECIMAL(10, 2) NOT NULL,
    estado_factura ENUM('Pagada', 'Pendiente', 'Cancelada') DEFAULT 'Pendiente',
    metodo_pago ENUM('Efectivo', 'Transferencia', 'Tarjeta de Cr√©dito', 'Cheque'),
    descripcion TEXT,
    fecha_vencimiento DATE,
    FOREIGN KEY (id_cliente) REFERENCES clientes(id),
    FOREIGN KEY (id_proyecto) REFERENCES proyecto(id_proyecto)
    );

ALTER TABLE materiales 
ADD COLUMN id_proveedor INT, 
ADD CONSTRAINT fk_id_proveedor FOREIGN KEY (id_proveedor) REFERENCES proveedores(id);  

CREATE TABLE proveedores_materiales (
    id INT AUTO_INCREMENT PRIMARY KEY,
    id_material INT NOT NULL,
    nombre_material VARCHAR(100),
    id_proveedor INT NOT NULL,
    nombre_proveedor VARCHAR(100),
    FOREIGN KEY (id_material) REFERENCES materiales(id_material),
    FOREIGN KEY (id_proveedor) REFERENCES proveedores(id)
);
